<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src='jquery-3.6.0.js'></script>
    <!-- Latest compiled and minified CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4" crossorigin="anonymous"></script>
</head>
<body class="bg-info" >
    <div class="h2 text-center bg-dark text-info">Notas Nol</div>
      <div class="container my-2">
        <div class="d-flex justify-content-around flex-column p-2 ">
            <div class="d-flex justify-content-around flex-row">
                <div class="d-flex">
                    <button id='ant' onclick='ant()' class='btn btn-dark'>Anterior</button>
                </div>
                <div class="d-flex">
                    <button id='sig' onclick='sig()' class='btn btn-dark'>Siguiente</button>
                </div>
            </div>
          </div>
      </div>
      
        
        <div class="container my-3">
            <div class="card text-white bg-primary mb-3" >
                <div class="card-header h3 ">Asignatura</div>
                <div class="card-body">
                  <div class="d-flex justify-content-around flex-column p-2">
                    <div class="d-flex justify-content-around flex-row">
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Acronimo</div>
                            <div class="p-2" id='acronimo'></div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Nombre</div>
                            <div class="p-2" id='nombre'></div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Creditos</div>
                            <div class="p-2" id='creditos'></div>
                        </div>
                        
                      </div>
                  </div>
                  <div class="d-flex justify-content-around flex-column p-2">
                    <div class="d-flex justify-content-around flex-row">
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Curso</div>
                            <div class="p-2" id='curso'></div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Cuatrimestre</div>
                            <div class="p-2" id='cuatrimestre'></div>
                        </div>
                    </div>
                  </div>
                  <div class="container" id='profs'>
	                  <div class="h4 text-warning">Profesores</div>
	                  
                  </div>
                  
                  <div class="d-flex justify-content-around flex-column p-2">
                    <div class="d-flex justify-content-around flex-row">
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Matriculados</div>
                            <div class="p-2 text-danger" id='matriculados'>0</div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Aprobados</div>
                            <div class="p-2 text-danger" id='aprobados'>0</div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Suspensos</div>
                            <div class="p-2 text-danger" id='suspensos'>0</div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >No Calificados</div>
                            <div class="p-2 text-danger" id='no'>0</div>
                        </div>
                        <div class="d-flex">
                            <div class="p-2 text-dark" >Nota Media</div>
                            <div class="p-2 text-danger" id='media'></div>
                        </div>
                    </div>
                  </div>
                  
                </div>
                </div>
                
              </div>

              <div class="container bg-dark" id='alumnos'>
                  <div class="h3 text-light">Alumnos</div>
                  <hr class="text-light">
                
              </div>
        
</body>

<script>
    let acronim ="";
	$.getJSON("getAsignatura")
	.done(function(res){
		acronim = res.acronimo;
		$('#nombre').text(res.nombre);
        $('#acronimo').text(res.acronimo);
        $('#creditos').text(res.creditos);
        $('#curso').text(res.curso);
        $('#cuatrimestre').text(res.cuatrimestre);
        asig = {
    			acronimo:res.acronimo
    	};
        $.ajax({
			url: 'GetProfs',
			method: "post",
			dataType: "json",
			data: asig,
			success: function(res) {
				var items = [];
				$.each(res, function(key, val) {
					items.push("<a class='list-group-item  list-group-item-dark'>"+val.nombre +" "+val.apellidos+"</a>");
				});
				$( "<div/>", {
				    "class": "list-group",
				    html: items.join( "" )
				  }).appendTo("#profs");
			}
		});
	});
	
	
var alumnos = {};

 	$.getJSON('GetAlumnos')
		.done(function(data){
			  var items1 = [];
			  var media = 0;
			  $.each(data, function(key, val) {
				alumnos[key] = val;
				if(val.nota != "") {
					if(val.nota < 5) $("#suspensos").html(parseInt($("#suspensos").html())+1);
					if(val.nota >= 5) $("#aprobados").html(parseInt($("#aprobados").html())+1);
				}
				else {
					$("#no").html(parseInt($("#no").html())+1);
				}
				
				$("#matriculados").html(parseInt($("#matriculados").html())+1);
				notaMedia();
				nota1 = val.nota;
				if(nota1 == "") nota1 = "No calificado";
			    items1.push("<div class='card col-md-5 m-auto my-1 border p-1 border-primary border-2 rounded'><img id='img"+key+"' width='150px' height='250px' class='card-img-top'><div class='card-body'><h4 class='card-title' id='dni"+key+"'>DNI: "+val.dni+"</h4><h4 id='nombre"+key+"'>Nombre: "+val.nombre+"</h4><h5 id='apellidos"+key+"'>Apellidos: "+val.apellidos+"</h5><h5 class='text-danger' id='nota"+key+"'>Nota: "+nota1+"</h5><button id='"+key+"' onclick='cambiarNota(this)' class='btn btn-primary'>Cambiar Nota</button></div></div>");
			    $.getJSON("Foto?dni="+val.dni)
			    	.done(function(res){
			    		$("#img"+key).attr("src", "data:image/png;base64,"+res.img);
			    	});
			  });
			  
			  $( "<div/>", {
			    "class": "row p-1",
			    html: items1.join( "" )
			  }).appendTo("#alumnos");
		});
 		
 		$("media").html(media)
		asig = {
 			acronimo: $("#acronimo").html()
 		}
 		function notaMedia(){
 			$.ajax({
 				url: 'NotaMedia',
 				method: "post",
 				dataType: "json",
 				data: asig,
 				success: function(res) {
 					console.log(res);
 					$("#media").html(res.media);
 				}
 			});
 		}
		function cambiarNota(event){
 			let nota = prompt("Por favor, introduce la nota");
 			let text;
 			if(nota < 0 || nota > 10 || nota == null || nota == ""){
 				alert("Valor incorrecto");
 				return;
 			}
 			
 			let datos = {
 					dni: alumnos[event.id].dni,
 					acronimo: $("#acronimo").html(),
 					nota: nota,
 			};
 			$.ajax({
 				url: 'CambiarNota',
 				method: "post",
 				dataType: "json",
 				data: datos,
 				success: function(res) {
 					notaAnt =$('#nota'+event.id).text();
 					notaAnt = notaAnt.substring(6);
 					console.log(notaAnt);
 					if(notaAnt == "No calificado"){
 						if (nota >= 5){
 							$("#aprobados").html(parseInt($("#aprobados").html())+1);
 							$("#no").html(parseInt($("#no").html())-1);
 						}
 						if (nota < 5){
 							$("#suspensos").html(parseInt($("#suspensos").html())+1);
 							$("#no").html(parseInt($("#no").html())-1);
 						}
 					}
 					else {
 						if(notaAnt < 5 && nota >= 5){
 							$("#aprobados").html(parseInt($("#aprobados").html())+1);
 							$("#suspensos").html(parseInt($("#suspensos").html())-1);
 						}
 						else if(notaAnt >= 5 && nota < 5) {
 							$("#aprobados").html(parseInt($("#aprobados").html())-1);
 							$("#suspensos").html(parseInt($("#suspensos").html())+1);
 						}
 					}
 					notaMedia();
 					$('#nota'+event.id).text("Nota: "+ nota);
 				}
 			});
 		}
		
		function sig() {
			$.getJSON('GetAsigProf')
			.done(function(data){
					var sig = "";
					var acronsig = "";
				  $.each(data, function(key, val) {
					 if(val.acronimo == $("#acronimo").html()) sig=key+1;
					 if(sig+1== data.length) sig = 0;
				  })
				  $.ajax({url : 'getAsignatura',
					      data : {acronimo: ' '},
					      method : 'post',
					      dataType : 'json',
					      success : function(response){
					            window.location.href = profesor.html;
					            }
					       })
		})
		}
		function ant() {
			$.getJSON('GetAsigProf')
			.done(function(data){
					var ant = "";
					var acronsig = "";
				  $.each(data, function(key, val) {
					 if(val.acronimo == $("#acronimo").html()) ant=key-1;
					 if(ant == -1) ant = data.length-1;
				  })
				  $.ajax({url : 'getAsignatura',
					      data : {acronimo: ' '},
					      method : 'post',
					      dataType : 'json',
					      success : function(response){
					            window.location.href = profesor.html;
					            }
					       })
		})
		}
		
			

</script>
<footer>
    <div class="text-center">Pagina usada para un proyecto en DEW</div>
    
</footer>
</html>